<!DOCTYPE html>
<html lang="en" data-theme="dark">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Obserpoint â€¢ Dashboard</title>
        <link rel="stylesheet" href="../global.css"/>
        <link rel="stylesheet" href="style.css"/>
    </head>
    <body>
        <div class="layout-container__div">
            <div class="sidebar__div">
                <!-- <div class="sidebar__item-main">
                    obserpoint logo (soon)
                </div> -->
                <div class="sidebar__item sidebar__item-top active" data-tab="home">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-house-icon lucide-house"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/><path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                </div>
                <div class="sidebar__item sidebar__item-top" data-tab="targets">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-target-icon lucide-target"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                </div>
                <div class="sidebar__item sidebar__item-top" data-tab="integrations">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-blocks-icon lucide-blocks"><path d="M10 22V7a1 1 0 0 0-1-1H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5a1 1 0 0 0-1-1H2"/><rect x="14" y="2" width="8" height="8" rx="1"/></svg>
                </div>
                <div class="sidebar__item sidebar__item-bottom" style="margin-top: auto;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-icon lucide-book"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20"/></svg>
                </div>
                <div class="sidebar__item sidebar__item-bottom">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles-icon lucide-sparkles"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/><path d="M20 3v4"/><path d="M22 5h-4"/><path d="M4 17v2"/><path d="M5 18H3"/></svg>
                </div>
            </div>
            <div class="inner-sidebar__div">
                <div class="inner-sidebar-group" data-section="home">
                    <div class="inner-sidebar__item active" data-tab="home__user-settings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cog-icon lucide-cog"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 2v2"/><path d="M12 22v-2"/><path d="m17 20.66-1-1.73"/><path d="M11 10.27 7 3.34"/><path d="m20.66 17-1.73-1"/><path d="m3.34 7 1.73 1"/><path d="M14 12h8"/><path d="M2 12h2"/><path d="m20.66 7-1.73 1"/><path d="m3.34 17 1.73-1"/><path d="m17 3.34-1 1.73"/><path d="m11 13.73-4 6.93"/></svg>
                        User Settings
                    </div>
                    <div class="inner-sidebar__item" data-tab="home__usage-limits">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card-icon lucide-credit-card"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
                        Usage Limits
                    </div>
                </div>
                <div class="inner-sidebar-group" data-section="targets">
                    <div class="inner-sidebar__item" data-tab="targets__list">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-crosshair-icon lucide-crosshair"><circle cx="12" cy="12" r="10"/><line x1="22" x2="18" y1="12" y2="12"/><line x1="6" x2="2" y1="12" y2="12"/><line x1="12" x2="12" y1="6" y2="2"/><line x1="12" x2="12" y1="22" y2="18"/></svg>
                        Target List
                    </div>
                </div>
                <div class="inner-sidebar-group" data-section="integrations">
                    <div class="inner-sidebar__item" data-tab="integrations__marketplace">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-store-icon lucide-store"><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12a2 2 0 0 1-2-2V7"/></svg>
                        Marketplace
                    </div>
                </div>
            </div>
            <div class="main-content__div">
                <div id="home__user-settings" class="tab-panel active">
                    <div class="page-info">
                        <h2 class="page-title">User Settings</h2>
                        <p class="page-subtitle">This is the user settings.</p>
                    </div>
                    <div class="user-setting-wrapper__div">
                        <div class="user-setting__div">
                            <div class="user-setting-info__div">
                                <h3>Pronouns</h3>
                                <p>Choose your pronouns.</p>
                            </div>
                            <div class="user-setting-modify__div">
                                <label for="pronouns">Pronouns</label>
                                <input type="text" id="pronouns" name="pronouns" placeholder="he/him, she/her, they/them..."/>
                                <button>Save</button>
                            </div>
                        </div>
                        <div class="user-setting__div">
                            <div class="user-setting-info__div">
                                <h3>Email</h3>
                                <p>Used for quicker logging in process and for the email notifier.</p>
                            </div>
                            <div class="user-setting-modify__div">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" placeholder="unnamed@emailprovider.domain"/>
                                <button id="save-email">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="home__usage-limits" class="tab-panel">
                    <div class="page-info">
                        <h2 class="page-title">Usage Limits</h2>
                        <p class="page-subtitle">This is your usage limits. Resets daily.</p>
                    </div>
                    <div class="usage-bar__wrapper" id="usage-bar-wrapper">
                        
                    </div>
                    <p id="usage-text">Loading...</p>
                </div>
                <div id="targets__list" class="tab-panel">
                    <div class="page-info">
                        <h2 class="page-title">All Targets</h2>
                        <p class="page-subtitle">All of your targets will be displayed here.</p>
                    </div>
                    <div class="targets-list__div">
                        <div class="target-create__div">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-plus-icon lucide-circle-plus"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                            Create a Target
                        </div>
                    </div>
                </div>
                <div id="targets__target-creation" class="tab-panel">
                    <div class="page-info">
                        <div class="target-config-name__wrapper">
                            <h2 class="page-title" id="target-name-display">Target Name</h2>
                            <input class="page-title__input" id="target-name-input" type="text" style="display: none;"/>
                            <svg id="edit-name-btn" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-line-icon lucide-pen-line"><path d="M12 20h9"/><path d="M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z"/></svg>
                            <svg id="save-name-btn" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-icon lucide-check" style="display: none;"><path d="M20 6 9 17l-5-5"/></svg> <!-- save svg; only appears when editing the name -->
                        </div>
                        <div class="target-config-note__wrapper">
                            <p class="page-subtitle"><i>Target Note</i></p>
                            <input class="page-subtitle__input" type="text" style="display: none;"/>
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-line-icon lucide-pen-line"><path d="M12 20h9"/><path d="M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z"/></svg>
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-icon lucide-check" style="display: none;"><path d="M20 6 9 17l-5-5"/></svg> <!-- save svg; only appears when editing the name -->
                        </div>
                    </div>
                    <div class="rate__wrapper">
                        <label for="interval__select">Rate</label><br>
                        <select id="interval__select">
                            <option value="30">30s</option>
                            <option value="60">1m</option>
                            <option value="120">2m</option>
                            <option value="180">3m</option>
                            <option value="300">5m</option>
                            <option value="600">10m</option>
                            <option value="1200">20m</option>
                        </select>
                    </div>
                    <div class="url-input__wrapper">
                        <label for="url__input">Url</label><br>
                        <input type="url" placeholder="https://your-website.extension/api-route/api-name" id="url__input">
                    </div>
                    <div class="action__buttons">
                        <button onclick="backToTargetsList()" class="back__button">Back</button>
                        <button class="create__button" id="create-target-btn">Create</button>
                    </div>
                </div>
                <div id="targets__target-config" class="tab-panel">
                    <div class="page-info">
                        <div class="target-config-name__wrapper">
                            <h2 class="page-title">Target Name</h2>
                            <input class="page-title__input" type="text" style="display: none;"/>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-line-icon lucide-pen-line"><path d="M12 20h9"/><path d="M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z"/></svg> <!-- pen svg; only appears when NOT editing the name -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-icon lucide-check" style="display: none;"><path d="M20 6 9 17l-5-5"/></svg> <!-- save svg; only appears when editing the name -->
                        </div>
                        <p class="page-subtitle"><i>Target Note</i></p>
                    </div>
                    <div class="page-warning__div">
                        <div class="page-warning-info__div">
                            <p class="page-warning-title">Hold Up!</p>
                            <p>It looks like you haven't saved yet.</p>
                        </div>
                        <button>Save</button>
                    </div>
                </div>
                <div id="integrations__marketplace" class="tab-panel">
                    <div class="page-info">
                        <h2 class="page-title">Integrations Marketplace</h2>
                        <p class="page-subtitle">Coming soon. Used to install integrations.</p>
                    </div>
                </div>
            </div>
        </div>
        <script>
            const createTargetButton = document.querySelector('.target-create__div');
            const targetsListPanel = document.getElementById('targets__list');
            const targetCreationPanel = document.getElementById('targets__target-creation');

            const nameDisplay = document.getElementById('target-name-display');
            const nameInput = document.getElementById('target-name-input');
            const editBtn = document.getElementById('edit-name-btn');
            const saveBtn = document.getElementById('save-name-btn');

            const createBtn = document.getElementById('create-target-btn');
            const intervalSelect = document.getElementById('interval__select');
            const urlInput = document.getElementById('url__input');

            const defaultTargetName = "Untitled Target";

            let currentTargetName = "Untitled Target";

            if (createTargetButton) {
                createTargetButton.addEventListener('click', () => {
                    document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
                    targetCreationPanel.classList.add('active');
                    document.querySelectorAll('.inner-sidebar__item').forEach(i => i.classList.remove('active'));

                    console.log(defaultTargetName);

                    currentTargetName = defaultTargetName;
                    nameDisplay.textContent = currentTargetName;
                    nameInput.value = currentTargetName;
                    nameDisplay.style.display = '';
                    nameInput.style.display = 'none';
                    editBtn.style.display = '';
                    saveBtn.style.display = 'none';
                });
            }

            function backToTargetsList() {
                document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
                targetsListPanel.classList.add('active');
                document.querySelector('[data-tab="targets__list"]').classList.add('active');
            }

            editBtn.addEventListener('click', () => {
                nameDisplay.style.display = 'none';
                nameInput.style.display = '';
                editBtn.style.display = 'none';
                saveBtn.style.display = '';
                nameInput.focus();
            });

            saveBtn.addEventListener('click', () => {
                currentTargetName = nameInput.value.trim() || 'Untitled Target';
                nameDisplay.textContent = currentTargetName;
                nameDisplay.style.display = '';
                nameInput.style.display = 'none';
                editBtn.style.display = '';
                saveBtn.style.display = 'none';
            });

            createBtn.addEventListener('click', async () => {
                const interval = intervalSelect.value;

                if (!['30', '60', '120', '180', '300', '600', '1200'].includes(interval)) {
                    alert("bro don't you dare try to exploit obserpoint he is my buddy");
                    return;
                }

                const urlPattern = /^(https?:\/\/)?(www\.)?([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(\/[^\s]*)?$/;
                if (!urlPattern.test(urlInput.value.trim())) {
                    alert("Please enter a valid URL.");
                    return;
                }
                
                try {
                    const res = await fetch('/targets', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: currentTargetName,
                            intervalSeconds: Number(interval),
                            url: urlInput.value.trim()
                        }),
                        credentials: 'include'
                    });

                    const data = await res.json();
                    if (!res.ok) {
                        alert('Failed to create target: ' + (data.message || 'Unknown error'));
                        return;
                    }

                    loadTargets();
                    backToTargetsList();
                } catch (error) {
                    console.error(error);
                    alert('Network error while creating target.')
                }
            })

            function activateTab(tabId) {
                document.querySelectorAll('.tab-panel').forEach(el => {
                    el.classList.remove('active');
                });
                const el = document.getElementById(tabId);
                if (el) el.classList.add('active');
            }

            function switchSection(section) {
                document.querySelectorAll('.sidebar__item').forEach(i => i.classList.remove('active'));
                document.querySelector(`.sidebar__item[data-tab="${section}"]`)?.classList.add('active');

                document.querySelectorAll('.inner-sidebar-group').forEach(group => {
                    if (group.dataset.section === section) {
                        group.classList.add('active');
                    } else {
                        group.classList.remove('active');
                    }
                });

                const defaultTab = document.querySelector(`.inner-sidebar-group[data-section="${section}"] .inner-sidebar__item`);
                if (defaultTab) {
                    document.querySelectorAll('.inner-sidebar__item').forEach(i => i.classList.remove('active'));
                    defaultTab.classList.add('active');
                    activateTab(defaultTab.dataset.tab);
                }
            }

            document.querySelectorAll('.sidebar__item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-tab');
                    switchSection(section);
                });
            });

            document.querySelectorAll('.inner-sidebar__item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.inner-sidebar__item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    activateTab(item.dataset.tab);
                });
            });

            switchSection('home');

            async function loadProfile() {
                const res = await fetch('/user/profile', { credentials: 'include' });
                if (!res.ok) return window.location.pathname = '/auth/sign-in';
                const { username, email } = await res.json();
                document.getElementById('email').value = email || '';
            }

            async function loadUsageBar() {
                const [usageRes, breakdownRes] = await Promise.all([
                    fetch('/user/usage', { credentials: 'include' }),
                    fetch('/user/usage-breakdown', { credentials: 'include' })
                ]);

                if (!usageRes.ok || !breakdownRes.ok) return console.error('Failed to load usage');

                const { credits, resetAt } = await usageRes.json();
                const breakdown = await breakdownRes.json();

                const used = 3000 - credits;
                const usageBar = document.getElementById('usage-bar-wrapper');
                usageBar.innerHTML = '';

                const colorMap = {
                    'Get': '#3BDE74',
                    'Mass get': '#36C96A',
                    'Create': '#3C7DC3',
                    'Get demo': '#D2772D',
                    'Unknown': '#3A3A3A'
                } // TODO use the css variables later on

                const totalUsed = Object.values(breakdown).reduce((a, b) => a + b, 0);

                for (const [type, cost] of Object.entries(breakdown)) {
                    const pct = (cost / 3000) * 100;
                    const segment = document.createElement('div');
                    segment.className = 'usage-segment';
                    segment.style.width = `${pct}%`;
                    segment.style.backgroundColor = colorMap[type] || colorMap.Unknown;
                    segment.title = `${type}: ${cost.toFixed(1)} credits`;
                    usageBar.appendChild(segment);
                }

                const text = document.getElementById('usage-text');
                text.textContent = `${credits.toFixed(0)} credits remaining (resets ${new Date(resetAt).toLocaleString()})`;
            }

            async function loadTargets() {
                const listContainer = document.querySelector('.targets-list__div');

                listContainer.querySelectorAll('.target-item').forEach(el => el.remove());

                try {
                    const res = await fetch('/targets', { credentials: 'include' });
                    if (!res.ok) {
                        console.error('Failed to fetch targets.');
                        return;
                    }

                    const targets = await res.json();
                    if (!Array.isArray(targets) || targets.length === 0) {
                        const emptyMessage = document.createElement('p');
                        emptyMessage.textContent = 'There are no targets yet. Create one!';
                        listContainer.appendChild(emptyMessage);
                        return;
                    }

                    targets.forEach(target => {
                        const newItem = document.createElement('div');
                        newItem.className = 'target-item';
                        newItem.innerHTML = `
                            <div class="target-item__main-info">
                                <p class="target-item__name">${target.name}</p>
                                <p class="target-item__rate">Every ${target.intervalSeconds}s</p>
                            </div>
                            <span style="color: #888;">${target.url}</span>
                        `;
                        newItem.addEventListener('click', () => openTargetConfig(target));
                        listContainer.appendChild(newItem);
                    });
                } catch (err) {
                    console.error('Error loading targets:', err);
                }
            }

            function openTargetConfig(target) {
                document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
                const configPanel = document.getElementById('targets__target-config');
                configPanel.classList.add('active');

                document.querySelectorAll('.inner-sidebar__item').forEach(i => i.classList.remove('active'));

                const nameEl = configPanel.querySelector('.target-config-name__wrapper .page-title');
                nameEl.textContent = target.name;
            }

            loadUsageBar();
            loadTargets();

            document.getElementById('save-email').addEventListener('click', async () => {
                const email = document.getElementById('email').value.trim();
                const res = await fetch('/user/profile', {
                    method: 'PATCH',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                if (!res.ok) {
                    console.error(data.message || 'Failed to save.');
                } else {
                    console.log(data.message);
                }
            });

            loadProfile();
        </script>
    </body>
</html>